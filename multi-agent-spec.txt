---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: agentworkflows.agents.enterprise.com
spec:
  group: agents.enterprise.com
  names:
    kind: AgentWorkflow
    listKind: AgentWorkflowList
    plural: agentworkflows
    singular: agentworkflow
  scope: Namespaced
  versions:
  - name: v1alpha1 # Stable, consolidated version
    served: true
    storage: true
    subresources:
      status: {}
    schema:
      openAPIV3Schema:
        description: AgentWorkflow defines a multi-agent workflow, orchestrating multiple Agents to automate a complex task using the A2A protocol.
        type: object
        properties:
          apiVersion: { type: string }
          kind: { type: string }
          metadata: { type: object }
          spec:
            description: AgentWorkflowSpec defines the desired state of a multi-agent workflow.
            type: object
            required: [ownership, participants, orchestration, topology]
            properties:
              ownership:
                description: Defines the owning entity and contact points for the workflow.
                type: object
                required: [team]
                properties:
                  team: { type: string }
                  organization: { type: string }
                  user: { type: string }
                  askId: { type: string }
                  sloEmail: { type: string, format: email }
              description:
                description: A detailed description of what this workflow accomplishes.
                type: string
                minLength: 20
              participants:
                description: A list of all agents that are part of this workflow.
                type: array
                minItems: 2
                items:
                  type: object
                  required: [alias, agentRef]
                  properties:
                    alias:
                      description: A short, unique name to reference this agent within the workflow topology.
                      type: string
                    agentRef:
                      description: A reference to a deployed Agent resource in the same namespace.
                      type: object
                      required: [name]
                      properties:
                        name: { type: string }
              orchestration:
                description: Defines the orchestrator agent and communication protocol.
                type: object
                required: [orchestrator, protocol]
                properties:
                  orchestrator:
                    description: The alias of the agent responsible for managing the workflow execution.
                    type: string
                  protocol:
                    description: Configuration for the inter-agent communication protocol.
                    type: object
                    required: [type, a2a]
                    properties:
                      type: { type: string, enum: [A2A] }
                      a2a:
                        description: Configuration for the Agent-to-Agent (A2A) protocol.
                        type: object
                        required: [registryServer]
                        properties:
                          registryServer:
                            description: The URL of the A2A Registry Server for agent discovery.
                            type: string
                            format: uri
              topology:
                description: Defines the structure and flow of the agent orchestration.
                type: object
                required: [mode, steps]
                properties:
                  mode:
                    description: The overall pattern of orchestration.
                    type: string
                    enum: [Sequential, Hierarchical, Parallel, Network]
                  steps:
                    description: The sequence of tasks or interactions in the workflow.
                    type: array
                    minItems: 1
                    items:
                      type: object
                      required: [name, agentAlias, task]
                      properties:
                        name:
                          description: A unique name for this step in the workflow.
                          type: string
                        agentAlias:
                          description: The alias of the agent performing this step.
                          type: string
                        task:
                          description: The specific instruction or goal for the agent in this step.
                          type: string
                        input:
                          description: Specifies the source of the input for this step (e.g., 'workflow.initialInput' or 'steps.step_name.output').
                          type: string
                        condition:
                          description: An optional condition that must be met for this step to execute (e.g., 'steps.triage_step.output.priority == "High"').
                          type: string
                        dependencies:
                          description: "For 'Network' mode, lists the names of steps that must be completed before this one begins."
                          type: array
                          items: { type: string }
          status:
            description: AgentWorkflowStatus defines the observed state of the workflow.
            type: object
            properties:
              phase: { type: string } # e.g., Pending, Running, Succeeded, Failed
              lastExecutionTime: { type: string, format: date-time }
              conditions:
                type: array
                items:
                  type: object
                  required: [type, status]
                  properties:
                    type: { type: string }
                    status: { type: string }
                    lastTransitionTime: { type: string, format: date-time }
                    message: { type: string }